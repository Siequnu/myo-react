{% extends "header_superintendant.html" %}
{% from 'bootstrap/form.html' import render_form %}
{% from 'bootstrap/form.html' import render_field %}
{% block app_content %}
{% block body %}

<style>
  .selected-activities-bucket {
    width: 100%;
    border: 1px solid rgba(128, 128, 128, 0.603);
    border-radius: 7.5px;
    min-height: 100px;
    padding: 10px;
  }
</style>

<div class="container">
  <div class="container">
    <div class="row">
      <div class="col">
        <button type="button" class="btn btn-lg btn-outline-secondary float-right" data-toggle="modal"
          data-target="#helpModal">
          <i class="fa fa-info"></i>
        </button>
        <h1><i class="fa fa-puzzle-piece"></i> Courses</h1>

      </div>
    </div>
    <hr>

    <p><a href="#"><button class="btn btn-outline-success" data-toggle="modal" data-target="#newCourseModal"><i
            class="fa fa-plus-circle"></i>
          New course</button></a></p>
    <br>

    <!-- New course modal -->
    <div class="modal fade" id="newCourseModal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-body">
            <h1 class="display-5"><i class="fa fa-puzzle-piece"></i> New course</h1>
            <hr class="my-4">
            <form method="post" action="{{url_for('activities.create_new_course')}}" enctype="multipart/form-data">
              <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
              {{ render_field(form.title) }}
              {{ render_field(form.description) }}

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            {{ render_field(form.submit, button_style="success") }}
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Add activities modal -->
    <div class="modal fade" id="addActivitiesModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-body">
            <h1 class="display-5"><i class="fa fa-puzzle-piece"></i> Add activities</h1>
            <hr class="my-4">

            <link rel="stylesheet" href="/static/css/form-control-borderless.css">
            <div class="row justify-content-left">
              <div class="col-12 col-md-10 col-lg-8">
                <form class="card">
                  <div class="card-body row no-gutters align-items-center">
                    <div class="col-auto">
                      <i class="fas fa-search h4 text-body">
                      </i>
                    </div>
                    <!--end of col-->
                    <div class="col">
                      <input id="myInput" class="form-control form-control-lg form-control-borderless" type="search"
                        placeholder="Search for activities">
                    </div>
                    <!--end of col-->
                  </div>
                </form>
              </div>
              <!--end of col-->
            </div>

            <br>
            <div class="table-responsive">
              <table id="dtBasicExample" summary="User table"
                class="table table-striped table-bordered table-sm table-hover text-small" cellspacing="0"
                style="width: auto;">
                <thead>
                  <tr>
                    <th><i class="fa fa-fingerprint"></i></th>
                    <th><i class="fa fa-plus-circle"></i></th>
                  </tr>
                </thead>
                <tbody id="searchableTable">
                  {% for activity in activities %}
                  <tr>
                    <td>{{activity.name}}</td>
                    <td>
                      <button class="btn btn-sm btn-outline-success add-single-activity"
                        data-activityid="{{activity.id}}"><i class="fa fa-plus-circle"></i>
                        Add</button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="modal-body">
            <hr>
            <h3 class="display-5"><i class="fa fa-puzzle-piece"></i> Current activities</h3>
            <div class="selected-activities-bucket">

            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-success add-activities" data-dismiss="modal">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Help modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-body">
            <h1 class="display-5"><i class="fa fa-puzzle-piece"></i> Courses</h1>
            <p class="lead">Engaging groups of activities.</p>
            <hr class="my-4">
            <p>You can create and manage courses from this page.</p>
            <p>After creating a course, you can add activities to it.</p>
            <p>You can view course statistics by clicking into each course.</p>
            <blockquote class="blockquote">
              <p class="mb-0">“Everything you can imagine is real.”</p>
              <footer class="blockquote-footer"><cite title="Source Title">Pablo Picasso</cite></footer>
            </blockquote>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <link rel="stylesheet" href="/static/css/form-control-borderless.css">
    <div class="row justify-content-left">
      <div class="col-12 col-md-10 col-lg-8">
        <form class="card">
          <div class="card-body row no-gutters align-items-center">
            <div class="col-auto">
              <i class="fas fa-search h4 text-body">
              </i>
            </div>
            <!--end of col-->
            <div class="col">
              <input id="myInput" class="form-control form-control-lg form-control-borderless" type="search"
                placeholder="Search for courses">
            </div>
            <!--end of col-->
          </div>
        </form>
      </div>
      <!--end of col-->
    </div>

    <br>
    <h3>Courses</h3>
    <br>

    {% if courses|length == 0 %}
    <p>There are no courses.</p>

    {% else %}
    <div class="table-responsive">
      <table id="dtBasicExample" summary="User table"
        class="table table-striped table-bordered table-sm table-hover text-small" cellspacing="0" width="100%">
        <thead>
          <tr>
            <th><i class="fa fa-heading"></i></th>
            <th><i class="fa fa-id-comment-dots"></i></th>
            <th><i class="fa fa-id-card-alt"></i></th>
            <th><i class="fa fa-tools"></i></th>
          </tr>
        </thead>
        <tbody id="searchableTable">
          {% for course in courses %}
          <tr>
            <td>{{course.title}}</td>
            <td>{{course.description}}</td>
            <td>{{course.user.username}}</td>
            <td>
              <a href="#" class="btn btn-outline-success btn-sm add-activities-form-button" role="button"
                data-toggle="modal" data-courseid="{{course.id}}" data-target="#addActivitiesModal"><i
                  class="fa fa-plus-circle"></i> Add activities</a>
              <a href="#" class="btn btn-outline-danger btn-sm" role="button"><i class="fa fa-trash-alt"></i> Remove</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
          </tr>
        </tfoot>
      </table>
    </div>
    <!--end of .table-responsive-->
    {% endif %}

  </div>
</div>
{% endblock %}
</div>
{% endblock %}

{% block templateScripts %}
<script type="text/javascript">
  $(function () {
    var currentCourseId = 0;

    // Add activities handler
    $('.add-activities-form-button').click(function () {
      var courseId = $(this).data('courseid');

      // Add this as a global variable
      currentCourseId = courseId;

      // Populate the activities
      populateActivities();

    })

    var populateActivities = function () {
      console.log('getting activities for course ' + currentCourseId);
      // Populate the modal
      $.ajax({
        url: '/activities/api/get/activities/' + currentCourseId,
        success: function (data) {
          $('.selected-activities-bucket').empty();
          $.each(data, function (indexInArray, activity) {
            console.log (activity);
            var html = '<button class="btn btn-outline-success activity-button" data-activityid="' +
              activity.id + '">';
            html += activity.activity_name;
            html += '<i class="fa fa-times-circle ml-2"></i>'
            html += '</button>';
            $('.selected-activities-bucket').append(html);
          });
          console.log(data);
        },
      });
    };

    // Handler to add an activity when clicking Add button
    $('.add-single-activity').click(function () {
      var activityId = $(this).data('activityid');
      console.log('Adding activity ' + activityId + ' to ' + currentCourseId);
      $.ajax({
        url: '/activities/api/add/activities/' + currentCourseId + '/' + activityId,
        success: function (data) {
          console.log(data);
          populateActivities();
        },
      });
    });

    // Handler to remove an activity
    $(document).on('click', '.activity-button', function () {
      var activityId = $(this).data('activityid');
      console.log('Removing activity ' + activityId + ' from ' + currentCourseId);
      $.ajax({
        url: '/activities/api/remove/activities/' + currentCourseId + '/' + activityId,
        success: function (data) {
          console.log(data);
          populateActivities();
        },
      });
    });
  })
</script>
{% endblock %}
