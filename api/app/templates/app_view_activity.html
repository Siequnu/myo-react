{% extends "header.html" %}
{% from 'bootstrap/form.html' import render_field %}
{% block app_content %}

<link rel="stylesheet" href="/static/css/myo.css">

<style>
    .container {
        max-width: none !important;
    }

    .lowerNavBar {
        z-index: 5;
    }

    i,
    span.fa,
    span.fas,
    span.far {
        color: orange
    }

    .btn.btn-primary {
        color: orange;
    }

    .alert.alert-info {
        background-color: #fff
    }

    h2.h5.my-3 {
        color: white;
    }

    .icon.icon-shape {
        width: 3.5rem;
        height: 3.5rem;
    }

    .icon span,
    .icon svg {
        font-size: 1.5rem;
    }

    .h5 {
        font-size: 1rem;
    }

    .shadow-soft {
        box-shadow: 1px 1px 8px #b8b9be, -1px -1px 3px #ffffff !important;
    }
</style>


<!-- Timer bar-->
<style>
    @keyframes pulse-waiting {

        0%,
        100% {
            background-color: #ffffff;
        }

        50% {
            background-color: orange;
        }
    }

    .timer-bar-container {
        height: 50px;
        width: 100%;
        position: fixed;
        z-index: 3;
        background-color: white;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
    }

    .timer-bar {
        height: 50px;
        width: 0%;
        position: fixed;
        background-color: orange;
        transition: 1s;
    }

    .timer-bar.waiting {
        animation: pulse-waiting 5s infinite;
    }

    .timerText {
        position: absolute;
        top: 12.5px;
        right: 40px;
        z-index: 10;
    }

    .pauseCircle {
        position: absolute;
        top: 12.5px;
        right: 12.5px;
        z-index: 10;
    }
</style>
<div class="timer-bar-container">
    <div class="timer-bar waiting">

    </div>
    <div id="time" class="timerText"></div>
    <div class="pauseCircle"><i class="fa fa-pause-circle"></i></div>
</div>
<script>
    $(function () {
        var timerIsActive = true;
        var initialTime = new Date(Date.now());
        $('.pauseCircle').hide();

        // Handler for pause circle timer click
        $('.pauseCircle').on('click', function () {
            timerIsActive = !timerIsActive
            if (timerIsActive) {
                $('.pauseCircle i').prop('class', 'fa fa-pause-circle');
            } else {
                $('.pauseCircle i').prop('class', 'fa fa-play-circle');
            }
        })

        // Update the timer
        function checkTime() {
            if (timerIsActive) {
                var timeDifference = Date.now() - initialTime;
                var formatted = convertTime(timeDifference);
                document.getElementById('time').innerHTML = '' + formatted;
            } else {
                initialTime.setSeconds(initialTime.getSeconds() + 1);
            }
        }

        // Helper function to convert the time
        function convertTime(miliseconds) {
            var totalSeconds = Math.floor(miliseconds / 1000);
            var minutes = Math.floor(totalSeconds / 60);
            var seconds = totalSeconds - minutes * 60;
            if (seconds < 10) {
                seconds = '0' + seconds;
            }
            return minutes + ':' + seconds;
        }

        // Check the time every 100 miliseconds


        // Function to handle the timer bar
        countDown = function () {
            if (timerIsActive) {
                $('.timer-bar').width($('.timer-bar').width() + 1)
            }
        };

        // Start this stuff when clicking start now
        $('#start-now').on('click', function () {
            // Timer bar
            $('.timer-bar').removeClass('waiting');
            window.setInterval(function () {
                countDown();
            }, 1100);

            // Timer clock 
            initialTime = new Date(Date.now());
            $('.pauseCircle').show();
            window.setInterval(checkTime, 1000);
        });
    });
</script>


<!-- Intro section-->
<style>
    .section.introduction .container {
        height: calc(100vh - 80px);
    }

    section.introduction img.thumbnail {
        height: 150px !important;
        width: 100%;
        object-fit: cover;
        border-radius: 15px;
        transform: scale(1.0);
        transition: transform .2s;
        /* Animation */
    }

    @media (min-height: 667px) {
        h1.display-1 {
            font-size: 0.9rem;
            padding-top: 5px;
            margin-top: 5px;
        }

        section.introduction img.thumbnail {
            height: 200px !important;
            width: 100%;
            object-fit: cover;
            border-radius: 15px;
            transform: scale(1.0);
            transition: transform .2s;
            /* Animation */
        }
    }

    section.introduction img.thumbnail:hover {
        transform: scale(1.03);
    }

    h1,
    p.lead {
        color: black;
    }

    h1.display-1 {
        font-size: 1.8rem;
    }

    p.lead {
        font-size: 1.0rem;
    }

    .scrolling-description-box {
        height: 150px;
        overflow-y: scroll;
    }

    @media (min-height: 667px) {
        .scrolling-description-box {
            height: 200px;
        }
    }

    #start-now {
        background-color: orange !important;
        color: white !important;
        position: relative;
        bottom: 10px;
    }

    #start-now i {
        color: white !important;
    }
</style>
<section class="section section bg-soft pb-2 overflow-hidden z-2 introduction" style="padding-top: 40px;">
    <div class="container" style="color: black;">
        <div class="row justify-content-center text-center pt-4">
            <div class="col-lg-8 col-xl-8">
                <img class="thumbnail" src="{{thumbnail_url}}" />
                <h1 class="display-1 mb-2 mt-4" style="color: black;">{{activity.title}}</h1>
                <div class="scrolling-description-box text-left">
                    <a class="badge badge-info text-uppercase mb-3" href="#">Skill</a>
                    <a class="badge badge-info text-uppercase mb-3" href="#">Meditation</a>

                    <p class="lead px-md-6 mb-3" style="font-weight: 400;">{{activity.description}}</p>
                </div>

                <div class="d-flex flex-column flex-wrap flex-md-row justify-content-md-center mt-3 mb-5">
                    <a href="#instructions" class="btn btn-pill btn-primary mr-3" id="start-now"> Start now<i
                            class="fa fa-chevron-down ml-2"></i></a>
                </div>
            </div>
        </div>
    </div>
</section>


<!-- Carousel section -->
<style>
    .carousel-item img {
        object-fit: cover;
    }

    .b-0 {
        bottom: 0;
    }

    .bg-shadow {
        background: rgba(76, 76, 76, 0);
        background: -webkit-gradient(left top, left bottom, color-stop(0%, rgba(179, 171, 171, 0)), color-stop(49%, rgba(48, 48, 48, 0.37)), color-stop(100%, rgba(19, 19, 19, 0.8)));
        background: linear-gradient(to bottom, rgba(179, 171, 171, 0) 0%, rgba(48, 48, 48, 0.71) 49%, rgba(19, 19, 19, 0.8) 100%);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#4c4c4c', endColorstr='#131313', GradientType=0);
    }

    .top-indicator {
        right: 0;
        top: 1rem;
        bottom: inherit;
        left: inherit;
        margin-right: 1rem;
        z-index: 1;
    }

    .overflow {
        position: relative;
        overflow: hidden;
    }

    .full-height-carousel {
        height: calc(100vh - 120px);
    }

    .carousel-item img {
        height: calc(30vh);
    }

    p {
        color: #FFFFFF;
    }

    .carousel p {
        color: #000000;
    }

    h2 {
        color: orange !important;
    }

    .carousel-control-prev-icon,
    .carousel-control-next-icon {
        color: orange;
        margin-bottom: 129%;
    }

    .btn-facebook,
    .btn-instagram,
    .btn-twitter {
        font-size: .8rem;
    }

    .text-card {
        margin-top: 70px;
        height: 55%;
        overflow-y: scroll;
        padding-bottom: 0 !important;
    }

    .feedback-button {
        display: inline-block;
        margin: 50px 0;
    }
</style>
<!-- Give us feedback modal -->
<!-- Last class star rating modal -->
<style>
    #lastClassComments {
        margin-top: 200px;
    }

    .rating {
        display: block;
        width: 100%;
        margin: auto;
        padding: 0;
        height: 80px;
    }

    /* :not(:checked) is a filter, so that browsers that don’t support :checked don’t 
  follow these rules. Every browser that supports :checked also supports :not(), so
  it doesn’t make the test unnecessarily selective */
    .rating:not(:checked)>input {
        position: absolute;
        top: -9999px;
        clip: rect(0, 0, 0, 0);
    }

    .rating:not(:checked)>label {
        float: right;
        width: 1em;
        /* padding:0 .1em; */
        overflow: hidden;
        white-space: nowrap;
        cursor: pointer;
        font-size: 300%;
        /* line-height:1.2; */
        color: #ddd;
    }

    .rating:not(:checked)>label:before {
        content: '★ ';
    }

    .rating>input:checked~label {
        color: orange;

    }

    .rating:not(:checked)>label:hover,
    .rating:not(:checked)>label:hover~label {
        color: orange;

    }

    .rating>input:checked+label:hover,
    .rating>input:checked+label:hover~label,
    .rating>input:checked~label:hover,
    .rating>input:checked~label:hover~label,
    .rating>label:hover~input:checked~label {
        color: orange;

    }

    .rating>label:active {
        position: relative;
        top: 2px;
        left: 2px;
    }
</style>
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">How did we do?</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h3>Rate this activity</h3>
                <div class="rating">
                    <input class="star" type="radio" id="star5" name="rating" value="5" /><label for="star5"
                        title="Excellent">5
                        stars</label>
                    <input class="star" type="radio" id="star4" name="rating" value="4" /><label for="star4"
                        title="Great">4
                        stars</label>
                    <input class="star" type="radio" id="star3" name="rating" value="3" /><label for="star3"
                        title="Good">3
                        stars</label>
                    <input class="star" type="radio" id="star2" name="rating" value="2" /><label for="star2"
                        title="Lacking">2
                        stars</label>
                    <input class="star" type="radio" id="star1" name="rating" value="1" /><label for="star1"
                        title="Disasterous">1 star</label>
                </div>
                <hr>
                <h3>Have any comments? We'd love to hear them</h3>
                <textarea rows="4" cols="50" style="width: 100%; border-radius: 15px; height: 100px; padding: 15px;"
                    id="comments" name="comments"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary send-feedback-button done-button" style="border-radius: 50px;">Send us
                    feedback</button>
            </div>
        </div>
    </div>
</div>


<div class="col-12" id="instructions" style="padding: 0; padding-top: 50px;">
    <div id="featured" class="carousel slide carousel" data-interval="false" data-ride="carousel">

        <!--dots navigate-->
        <ol class="carousel-indicators top-indicator">
            {% for page in activity.pages %}
            <li data-target="#featured" data-slide-to="{{loop.index -1 }}" {% if loop.index <=1 %} class="active"
                {% endif %}></li>

            <!-- Add the share page on the last loop-->
            {% if loop.index == loop.length %}
            <li data-target="#featured" data-slide-to="{{loop.length}}"></li>
            {% endif %}

            {% endfor %}
        </ol>

        <!--carousel inner-->
        <div class="carousel-inner">
            {% for page in activity.pages %}
            <!--Item slider-->
            {% if loop.index <=1 %}
            <div class="carousel-item active">
                {% else %}
                <div class="carousel-item">
                    {% endif %}
                    <div class="card border-0 rounded-0 text-light overflow zoom">
                        <div class="position-relative full-height-carousel">
                            <!--thumbnail img-->
                            <div class="ratio_left-cover-1 image-wrapper">
                                <a href="#instructions">
                                    <img class="img-fluid w-100"
                                        src="/static/activities/{{activity_id + 1}}/{{page.thumbnail}}">
                                </a>
                            </div>
                            <div class="text-card p-2 p-lg-3 b-0 w-100">
                                <h2>{{page.title}}</h2>
                                <p>{{page.description|safe}}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add the share page template on the last carousel-->
                {% if loop.index == loop.length %}
                <div class="carousel-item">
                    <div class="card border-0 rounded-0 text-light overflow zoom text-center">
                        <div class="position-relative full-height-carousel">
                            <!--thumbnail img-->
                            <div class="ratio_left-cover-1 image-wrapper">
                                <a href="#instructions">
                                    <img class="img-fluid w-100" src="/static/videos/confetti.mp4">
                                </a>
                            </div>
                            <div class="text-card p-2 p-lg-3 b-0 w-100">
                                <h2>Congratulations</h2>
                                <a class="give-us-feedback" href="#instructions">How did you find this exercise?</a>
                                <style>
                                    .feedback-button {
                                        margin: 10px 0;
                                    }
                                </style>
                                <button type="button" class="btn btn-pill btn-primary mr-3 feedback-button"
                                    data-toggle="modal" data-target="#feedbackModal">
                                    Give us feedback 😀
                                </button>
                                <button type="button" class="btn btn-pill btn-primary mr-3 done-button">
                                    I'm done<i class="fa fa-chevron-right ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <!--navigation-->
            <a class="carousel-control-prev" href="#featured" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#featured" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
        </div>
        <!--End slider news-->

        <section class="section section bg-soft pb-5 overflow-hidden z-2" style="padding-top: 50px;">
        </section>

        {% include 'lower_nav.html' %}


        {% block templateScripts %}

        <script>
            $(function () {
                $('.lowerNavBar a').removeClass('active');
                $('.lowerNavBar a.spark').addClass('active');
            });
        </script>

        <!-- Feedback handler -->
        <script>
            $(function () {
                $('.send-feedback-button').click(function () {
                    var feedback = {
                        textFeedback: $('#comments').val(),
                        starFeedback: getStarRating()
                    }

                    submitQuestions (feedback);
                })

                var getStarRating = function () {
                    var rating = 0;
                    $.each($('.rating input'), function (indexInArray, element) {
                        if ($(element).prop('checked')) {
                            rating = $(element).prop('value');
                        }
                    });
                    return rating;
                };

                var submitQuestions = function (feedback) {

                    const csrftoken = Cookies.get('_csrf_token');
                    var activityId = {{activity_id+1}};

                    // Send the AJAX call
                    var apiUrl = '/activities/api/feedback/' + activityId;

                    fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json;charset=utf-8',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({
                            feedback: feedback
                        })
                    }).then(res => res.json()).then(data => {
                        if (!data.hasOwnProperty('error')) {
                            // Do nothing on successful data entry
                            console.log(data);
                            // Redirect to the new page
                            window.location.replace('/activities/spark');
                        } else {
                            // There was an error...
                            console.log(data);
                        }
                    });
                };
            });
        </script>

        <!-- Activity complete handler -->
        <script>
            $(function () {
                $('.done-button').click(function () {
                    markAsComplete ();
                })

                var markAsComplete = function () {

                    const csrftoken = Cookies.get('_csrf_token');
                    var activityId = {{activity_id+1}};

                    // Send the AJAX call
                    var apiUrl = '/activities/api/complete/' + activityId;

                    fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json;charset=utf-8',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({
                        })
                    }).then(res => res.json()).then(data => {
                        if (!data.hasOwnProperty('error')) {
                            // Do nothing on successful data entry
                            console.log(data);
                            // Redirect to the new page
                            window.location.replace('/activities/spark');
                        } else {
                            // There was an error...
                            console.log(data);
                        }
                    });
                };
            });
        </script>
        {% endblock %}

        {% endblock %}
